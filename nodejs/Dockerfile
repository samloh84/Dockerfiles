ARG NODEJS_VERSION="12.18.1"
ARG NODEJS_TEMP_DIR="/tmp/nodejs"
ARG NODEJS_SRC_DIR="${NODEJS_TEMP_DIR}/src"
ARG NODEJS_INSTALL_DIR="/opt/nodejs"
ARG NODEJS_ARCHIVE_FILE="node-v${NODEJS_VERSION}.tar.gz"
ARG NODEJS_ARCHIVE_URL="https://nodejs.org/dist/v${NODEJS_VERSION}/${NODEJS_ARCHIVE_FILE}"
ARG NODEJS_ARCHIVE_PATH="${NODEJS_TEMP_DIR}/${NODEJS_ARCHIVE_FILE}"
ARG NODEJS_ARCHIVE_CHECKSUM_FILE="SHASUMS256.txt"
ARG NODEJS_ARCHIVE_CHECKSUM_URL="https://nodejs.org/dist/v${NODEJS_VERSION}/${NODEJS_ARCHIVE_CHECKSUM_FILE}"
ARG NODEJS_ARCHIVE_CHECKSUM_PATH="${NODEJS_TEMP_DIR}/${NODEJS_ARCHIVE_CHECKSUM_FILE}"
ARG NODEJS_ARCHIVE_CHECKSUM_SIGNATURE_FILE="${NODEJS_ARCHIVE_CHECKSUM_FILE}.asc"
ARG NODEJS_ARCHIVE_CHECKSUM_SIGNATURE_URL="https://nodejs.org/dist/v${NODEJS_VERSION}/${NODEJS_ARCHIVE_CHECKSUM_SIGNATURE_FILE}"
ARG NODEJS_ARCHIVE_CHECKSUM_SIGNATURE_PATH="${NODEJS_TEMP_DIR}/${NODEJS_ARCHIVE_CHECKSUM_SIGNATURE_FILE}"
ARG NODEJS_GPG_PUBLIC_KEY_IDS="4ED778F539E3634C779C87C6D7062848A1AB005C 94AE36675C464D64BAFA68DD7434390BDBE9B9C5 71DCFD284A79C3B38668286BC97EC7A07EDE3FC1 8FCCA13FEF1D0C2E91008E09770F7A9A5AE15600 C4F0DFFF4E8C1A8236409D08E73BC641CC11F4C8 DD8F2338BAE7501E3DD5AC78C273792F7D83545D A48C2BEE680E841632CD4E44F07496B3EB3C1762 B9E2F5981AA6E0CD28160D9FF13993A75599653C"
ARG NODEJS_GPG_KEYRING_FILE="nodejs.gpg"
ARG NODEJS_GPG_KEYRING_PATH="${NODEJS_TEMP_DIR}/${NODEJS_GPG_KEYRING_FILE}"
ARG NODEJS_DEPENDENCIES_FILE="nodejs-dependencies.txt"
ARG NODEJS_DEPENDENCIES_PATH="${NODEJS_INSTALL_DIR}/${NODEJS_DEPENDENCIES_FILE}"

FROM fedora:latest AS builder

ARG NODEJS_VERSION
ARG NODEJS_TEMP_DIR
ARG NODEJS_SRC_DIR
ARG NODEJS_INSTALL_DIR
ARG NODEJS_ARCHIVE_FILE
ARG NODEJS_ARCHIVE_URL
ARG NODEJS_ARCHIVE_PATH
ARG NODEJS_ARCHIVE_CHECKSUM_FILE
ARG NODEJS_ARCHIVE_CHECKSUM_URL
ARG NODEJS_ARCHIVE_CHECKSUM_PATH
ARG NODEJS_ARCHIVE_CHECKSUM_SIGNATURE_FILE
ARG NODEJS_ARCHIVE_CHECKSUM_SIGNATURE_URL
ARG NODEJS_ARCHIVE_CHECKSUM_SIGNATURE_PATH
ARG NODEJS_GPG_PUBLIC_KEY_IDS
ARG NODEJS_GPG_KEYRING_FILE
ARG NODEJS_GPG_KEYRING_PATH
ARG NODEJS_DEPENDENCIES_FILE
ARG NODEJS_DEPENDENCIES_PATH

RUN \
set -euxo pipefail && \
dnf update -y && \
dnf install -y \
findutils xz make gcc gcc-g++ zlib-devel bzip2 bzip2-devel openssl-devel gnupg2 \
which python2 && \
dnf clean all && \
mkdir -p "${NODEJS_TEMP_DIR}" "${NODEJS_SRC_DIR}" "${NODEJS_INSTALL_DIR}" && \
curl -sSLj -o "${NODEJS_ARCHIVE_PATH}" "${NODEJS_ARCHIVE_URL}" && \
curl -sSLj -o "${NODEJS_ARCHIVE_CHECKSUM_PATH}" "${NODEJS_ARCHIVE_CHECKSUM_URL}" && \
curl -sSLj -o "${NODEJS_ARCHIVE_CHECKSUM_SIGNATURE_PATH}" "${NODEJS_ARCHIVE_CHECKSUM_SIGNATURE_URL}" && \
for NODEJS_GPG_PUBLIC_KEY_ID in ${NODEJS_GPG_PUBLIC_KEY_IDS}; do \
gpg --keyserver pool.sks-keyservers.net --recv-keys "${NODEJS_GPG_PUBLIC_KEY_ID}"; \
done && \
cd "${NODEJS_TEMP_DIR}" && \
gpg --verify "${NODEJS_ARCHIVE_CHECKSUM_SIGNATURE_FILE}" && \
cat "${NODEJS_ARCHIVE_CHECKSUM_PATH}" | grep "${NODEJS_ARCHIVE_FILE}" | sha256sum --check && \
tar -C "${NODEJS_SRC_DIR}" --strip-components=1 -xf "${NODEJS_ARCHIVE_PATH}" && \
cd "${NODEJS_SRC_DIR}" && \
./configure --prefix="${NODEJS_INSTALL_DIR}" && \
make -j$(nproc) && \
make install && \
rm -rf "${NODEJS_TEMP_DIR}" && \
find "${NODEJS_INSTALL_DIR}" -type f -executable -exec ldd {} \; | \
grep '=>' | \
awk '{print $3}' | \
sort --unique | \
xargs -L1 rpm -qf | \
sort --unique | \
tee "${NODEJS_DEPENDENCIES_PATH}"

FROM fedora:latest

ARG NODEJS_INSTALL_DIR
ARG NODEJS_DEPENDENCIES_FILE
ARG NODEJS_DEPENDENCIES_PATH

COPY --from=builder ${NODEJS_INSTALL_DIR} ${NODEJS_INSTALL_DIR}

ENV PATH="${PATH}:${NODEJS_INSTALL_DIR}/bin"

RUN dnf install -y $(cat "${NODEJS_DEPENDENCIES_PATH}") && \
rm -rf "${NODEJS_DEPENDENCIES_PATH}" && \
dnf clean all

CMD node



ARG PYTHON2_VERSION="2.7.18"
ARG PYTHON2_TEMP_DIR="/tmp/python"
ARG PYTHON2_SRC_DIR="${PYTHON2_TEMP_DIR}/src"
ARG PYTHON2_INSTALL_DIR="/opt/python"
ARG PYTHON2_ARCHIVE_FILE="Python-${PYTHON2_VERSION}.tar.xz"
ARG PYTHON2_ARCHIVE_URL="https://www.python.org/ftp/python/${PYTHON2_VERSION}/${PYTHON2_ARCHIVE_FILE}"
ARG PYTHON2_ARCHIVE_PATH="${PYTHON2_TEMP_DIR}/${PYTHON2_ARCHIVE_FILE}"
ARG PYTHON2_ARCHIVE_SIGNATURE_FILE="${PYTHON2_ARCHIVE_FILE}.asc"
ARG PYTHON2_ARCHIVE_SIGNATURE_URL="https://www.python.org/ftp/python/${PYTHON2_VERSION}/${PYTHON2_ARCHIVE_SIGNATURE_FILE}"
ARG PYTHON2_ARCHIVE_SIGNATURE_PATH="${PYTHON2_TEMP_DIR}/${PYTHON2_ARCHIVE_SIGNATURE_FILE}"
ARG PYTHON2_PUBLIC_KEY_URL="https://keybase.io/bp/pgp_keys.asc?fingerprint=c01e1cad5ea2c4f0b8e3571504c367c218add4ff"
ARG PYTHON2_PUBLIC_KEY_FILE="bp.asc"
ARG PYTHON2_PUBLIC_KEY_PATH="${PYTHON2_TEMP_DIR}/${PYTHON2_PUBLIC_KEY_FILE}"
ARG PYTHON2_GPG_KEYRING_FILE="python.gpg"
ARG PYTHON2_GPG_KEYRING_PATH="${PYTHON2_TEMP_DIR}/${PYTHON2_GPG_KEYRING_FILE}"
ARG PYTHON2_DEPENDENCIES_FILE="python-dependencies.txt"
ARG PYTHON2_DEPENDENCIES_PATH="${PYTHON2_INSTALL_DIR}/${PYTHON2_DEPENDENCIES_FILE}"

FROM fedora:latest AS builder

ARG PYTHON2_VERSION
ARG PYTHON2_TEMP_DIR
ARG PYTHON2_SRC_DIR
ARG PYTHON2_INSTALL_DIR
ARG PYTHON2_ARCHIVE_FILE
ARG PYTHON2_ARCHIVE_URL
ARG PYTHON2_ARCHIVE_PATH
ARG PYTHON2_ARCHIVE_SIGNATURE_FILE
ARG PYTHON2_ARCHIVE_SIGNATURE_URL
ARG PYTHON2_ARCHIVE_SIGNATURE_PATH
ARG PYTHON2_PUBLIC_KEY_URL
ARG PYTHON2_PUBLIC_KEY_FILE
ARG PYTHON2_PUBLIC_KEY_PATH
ARG PYTHON2_GPG_KEYRING_FILE
ARG PYTHON2_GPG_KEYRING_PATH
ARG PYTHON2_DEPENDENCIES_FILE
ARG PYTHON2_DEPENDENCIES_PATH

RUN \
set -euxo pipefail && \
dnf update -y && \
dnf install -y \
findutils xz make gcc zlib-devel bzip2 bzip2-devel readline-devel \
sqlite sqlite-devel openssl-devel tk-devel libffi-devel && \
dnf clean all && \
mkdir -p "${PYTHON2_TEMP_DIR}" "${PYTHON2_SRC_DIR}" "${PYTHON2_INSTALL_DIR}" && \
curl -sSLj -o "${PYTHON2_ARCHIVE_PATH}" "${PYTHON2_ARCHIVE_URL}" && \
curl -sSLj -o "${PYTHON2_ARCHIVE_SIGNATURE_PATH}" "${PYTHON2_ARCHIVE_SIGNATURE_URL}" && \
curl -sSLj -o "${PYTHON2_PUBLIC_KEY_PATH}" "${PYTHON2_PUBLIC_KEY_URL}" && \
gpg --no-default-keyring --keyring "${PYTHON2_GPG_KEYRING_PATH}" --import "${PYTHON2_PUBLIC_KEY_PATH}" && \
cd "${PYTHON2_TEMP_DIR}" && \
gpg --no-default-keyring --keyring "${PYTHON2_GPG_KEYRING_PATH}" --verify "${PYTHON2_ARCHIVE_SIGNATURE_FILE}" && \
tar -C "${PYTHON2_SRC_DIR}" --strip-components=1 -xf "${PYTHON2_ARCHIVE_PATH}" && \
cd "${PYTHON2_SRC_DIR}" && \
./configure --prefix="${PYTHON2_INSTALL_DIR}" && \
make -j$(nproc) && \
make install && \
rm -rf "${PYTHON2_TEMP_DIR}" && \
find "${PYTHON2_INSTALL_DIR}" -type f -executable -exec ldd {} \; | \
grep '=>' | \
awk '{print $3}' | \
sort --unique | \
xargs -L1 rpm -qf | \
sort --unique | \
tee "${PYTHON2_DEPENDENCIES_PATH}"

FROM fedora:latest

ARG PYTHON2_INSTALL_DIR
ARG PYTHON2_DEPENDENCIES_FILE
ARG PYTHON2_DEPENDENCIES_PATH

COPY --from=builder ${PYTHON2_INSTALL_DIR} ${PYTHON2_INSTALL_DIR}

ENV PATH="${PATH}:${PYTHON2_INSTALL_DIR}/bin"

RUN dnf install -y $(cat "${PYTHON2_DEPENDENCIES_PATH}") && \
rm -rf "${PYTHON2_DEPENDENCIES_PATH}" && \
dnf clean all && \
python -m ensurepip


CMD python



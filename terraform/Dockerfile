ARG TERRAFORM_VERSION="0.13.0"
ARG TERRAFORM_TEMP_DIR="/tmp/terraform"
ARG TERRAFORM_INSTALL_DIR="/opt/terraform"
ARG TERRAFORM_ARCHIVE_FILE="terraform_${TERRAFORM_VERSION}_linux_amd64.zip"
ARG TERRAFORM_ARCHIVE_URL="https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/${TERRAFORM_ARCHIVE_FILE}"
ARG TERRAFORM_ARCHIVE_PATH="${TERRAFORM_TEMP_DIR}/${TERRAFORM_ARCHIVE_FILE}"
ARG TERRAFORM_ARCHIVE_CHECKSUMS_FILE="terraform_${TERRAFORM_VERSION}_SHA256SUMS"
ARG TERRAFORM_ARCHIVE_CHECKSUMS_URL="https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/${TERRAFORM_ARCHIVE_CHECKSUMS_FILE}"
ARG TERRAFORM_ARCHIVE_CHECKSUMS_PATH="${TERRAFORM_TEMP_DIR}/${TERRAFORM_ARCHIVE_CHECKSUMS_FILE}"
ARG TERRAFORM_ARCHIVE_CHECKSUMS_SIGNATURE_FILE="terraform_${TERRAFORM_VERSION}_SHA256SUMS.sig"
ARG TERRAFORM_ARCHIVE_CHECKSUMS_SIGNATURE_URL="https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/${TERRAFORM_ARCHIVE_CHECKSUMS_SIGNATURE_FILE}"
ARG TERRAFORM_ARCHIVE_CHECKSUMS_SIGNATURE_PATH="${TERRAFORM_TEMP_DIR}/${TERRAFORM_ARCHIVE_CHECKSUMS_SIGNATURE_FILE}"
ARG TERRAFORM_PUBLIC_KEY_URL="https://keybase.io/hashicorp/pgp_keys.asc?fingerprint=91a6e7f85d05c65630bef18951852d87348ffc4c"
ARG TERRAFORM_PUBLIC_KEY_FILE="hashicorp.asc"
ARG TERRAFORM_PUBLIC_KEY_PATH="${TERRAFORM_TEMP_DIR}/${TERRAFORM_PUBLIC_KEY_FILE}"
ARG TERRAFORM_GPG_KEYRING_FILE="terraform.gpg"
ARG TERRAFORM_GPG_KEYRING_PATH="${TERRAFORM_TEMP_DIR}/${TERRAFORM_GPG_KEYRING_FILE}"

FROM fedora:latest AS builder

ARG TERRAFORM_VERSION
ARG TERRAFORM_TEMP_DIR
ARG TERRAFORM_INSTALL_DIR
ARG TERRAFORM_ARCHIVE_FILE
ARG TERRAFORM_ARCHIVE_URL
ARG TERRAFORM_ARCHIVE_PATH
ARG TERRAFORM_ARCHIVE_CHECKSUMS_FILE
ARG TERRAFORM_ARCHIVE_CHECKSUMS_URL
ARG TERRAFORM_ARCHIVE_CHECKSUMS_PATH
ARG TERRAFORM_ARCHIVE_CHECKSUMS_SIGNATURE_FILE
ARG TERRAFORM_ARCHIVE_CHECKSUMS_SIGNATURE_URL
ARG TERRAFORM_ARCHIVE_CHECKSUMS_SIGNATURE_PATH
ARG TERRAFORM_PUBLIC_KEY_URL
ARG TERRAFORM_PUBLIC_KEY_FILE
ARG TERRAFORM_PUBLIC_KEY_PATH
ARG TERRAFORM_GPG_KEYRING_FILE
ARG TERRAFORM_GPG_KEYRING_PATH

RUN \
set -euxo pipefail && \
dnf update -y && \
dnf install -y \
unzip && \
dnf clean all && \
mkdir -p "${TERRAFORM_TEMP_DIR}" "${TERRAFORM_INSTALL_DIR}" && \
curl -sSLj -o "${TERRAFORM_ARCHIVE_PATH}" "${TERRAFORM_ARCHIVE_URL}" && \
curl -sSLj -o "${TERRAFORM_ARCHIVE_CHECKSUMS_PATH}" "${TERRAFORM_ARCHIVE_CHECKSUMS_URL}" && \
curl -sSLj -o "${TERRAFORM_ARCHIVE_CHECKSUMS_SIGNATURE_PATH}" "${TERRAFORM_ARCHIVE_CHECKSUMS_SIGNATURE_URL}" && \
curl -sSLj -o "${TERRAFORM_PUBLIC_KEY_PATH}" "${TERRAFORM_PUBLIC_KEY_URL}" && \
gpg --no-default-keyring --keyring "${TERRAFORM_GPG_KEYRING_PATH}" --import "${TERRAFORM_PUBLIC_KEY_PATH}" && \
cd "${TERRAFORM_TEMP_DIR}" && \
gpg --no-default-keyring --keyring "${TERRAFORM_GPG_KEYRING_PATH}" --verify "${TERRAFORM_ARCHIVE_CHECKSUMS_SIGNATURE_FILE}" && \
grep "${TERRAFORM_ARCHIVE_FILE}" "${TERRAFORM_ARCHIVE_CHECKSUMS_FILE}" | sha256sum -c - && \
unzip -d "${TERRAFORM_INSTALL_DIR}" "${TERRAFORM_ARCHIVE_PATH}" && \
rm -rf "${TERRAFORM_TEMP_DIR}"

ENV PATH="${PATH}:${TERRAFORM_INSTALL_DIR}"

CMD terraform


